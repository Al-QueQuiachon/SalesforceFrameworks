<template>
    <div class="survey-responder-container" style={componentStyle}>
        <template if:true={isLoading}>
            <div class="loading-container">
                <lightning-spinner alternative-text="Loading survey..." size="large"></lightning-spinner>
                <p>Loading Survey...</p>
            </div>
        </template>

        <template if:true={loadError}>
            <div class="error-panel" role="alert">
                <h2 class="error-title">Error Loading Survey</h2>
                <p>{loadError}</p>
                <!-- Optionally add a retry button if applicable -->
            </div>
        </template>

        <template if:true={surveyData}>
            <!-- Survey Welcome/Header -->
            <header class="survey-header slds-m-bottom_large">
                <h1 class="survey-title">{surveyData.survey.Name}</h1>
                <template if:true={surveyData.survey.Description__c}>
                    <p class="survey-description">{surveyData.survey.Description__c}</p>
                </template>
                <template if:true={surveyData.survey.Welcome_Message__c}>
                    <div class="survey-welcome slds-m-top_medium">
                        <lightning-formatted-rich-text value={surveyData.survey.Welcome_Message__c}></lightning-formatted-rich-text>
                    </div>
                </template>
            </header>

            <!-- Survey Questions -->
            <form class="survey-form">
                <template for:each={surveyData.questions} for:item="question" for:index="qIndex">
                    <div key={question.Id} class="question-container slds-m-bottom_large">
                        <label class="question-label">
                            <span class="question-number">{question.displayOrder}.</span>
                            <span class="question-text">{question.Question_Text__c}</span>
                            <template if:true={question.Is_Required__c}>
                                <abbr class="slds-required" title="required">*</abbr>
                            </template>
                        </label>

                        <!-- Render Input based on Question Type -->
                        <div class="question-input-area slds-m-left_large">
                            <template if:true={question.isText}>
                                <lightning-input
                                    type="text"
                                    data-id={question.Id}
                                    onchange={handleResponseChange}
                                    required={question.Is_Required__c}
                                    message-when-value-missing="This field is required."
                                ></lightning-input>
                            </template>

                            <template if:true={question.isTextarea}>
                                <lightning-textarea
                                    data-id={question.Id}
                                    onchange={handleResponseChange}
                                    required={question.Is_Required__c}
                                    message-when-value-missing="This field is required."
                                ></lightning-textarea>
                            </template>

                            <template if:true={question.isRadio}>
                                <lightning-radio-group
                                    name={question.Id}
                                    options={question.Answer_Options__r}
                                    type="radio"
                                    data-id={question.Id}
                                    onchange={handleResponseChange}
                                    required={question.Is_Required__c}
                                    message-when-value-missing="Please select an option."
                                ></lightning-radio-group>
                            </template>

                            <template if:true={question.isCheckbox}>
                                <lightning-checkbox-group
                                    name={question.Id}
                                    options={question.Answer_Options__r}
                                    data-id={question.Id}
                                    onchange={handleResponseChange}
                                    required={question.Is_Required__c}
                                    message-when-value-missing="Please select at least one option."
                                ></lightning-checkbox-group>
                            </template>

                            <template if:true={question.isRating}>
                                <div class="rating-group">
                                    <template for:each={ratingOptions} for:item="rating">
                                        <button
                                            key={rating.value}
                                            type="button"
                                            class={rating.class}
                                            data-id={question.Id}
                                            data-value={rating.value}
                                            onclick={handleRatingClick}
                                            aria-pressed={rating.selected}
                                            title={rating.value}
                                        >
                                            <!-- Simple star or circle SVG -->
                                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" stroke="none">
                                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                            </svg>
                                        </button>
                                    </template>
                                    <!-- Add hidden input for validation if needed -->
                                    <input type="hidden" data-id={question.Id} required={question.Is_Required__c} class="rating-validation-input">
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Submission Area -->
                <div class="submission-section slds-m-top_large">
                    <button type="button" class="submit-button" onclick={handleSubmit} disabled={isSubmitting}>
                        <template if:true={isSubmitting}>
                            <lightning-spinner alternative-text="Submitting..." size="small" class="button-spinner"></lightning-spinner>
                            <span>Submitting...</span>
                        </template>
                        <template if:false={isSubmitting}>
                            <span>Submit Response</span>
                        </template>
                    </button>
                    <template if:true={submitError}>
                        <p class="error-text slds-m-top_small">{submitError}</p>
                    </template>
                </div>
            </form>
        </template>

        <!-- Thank You Message -->
        <template if:true={isCompleted}>
            <div class="thank-you-container slds-m-top_large">
                <div class="thank-you-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 4L12 14.01l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h2 class="thank-you-title">Thank You!</h2>
                <p class="thank-you-message">Your response has been submitted successfully.</p>
                <template if:true={surveyData.survey.Thank_You_Message__c}>
                    <div class="survey-thankyou-custom slds-m-top_medium">
                        <lightning-formatted-rich-text value={surveyData.survey.Thank_You_Message__c}></lightning-formatted-rich-text>
                    </div>
                </template>
            </div>
        </template>
    </div>
</template> 